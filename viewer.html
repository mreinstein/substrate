<!DOCTYPE html>
<html>
<head>
    <title>Substrate</title>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
    <script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/languages/javascript.min.js"></script>

    <style>
        body {
            margin: 0;
            background-color: #313638;
            color: white;
            font-family: monospace;

            text-rendering: optimizeLegibility;
            overscroll-behavior: none;
            touch-action: none;
        }

        .outer-container {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            grid-template-areas: "preview";
            grid-gap: 0px;

            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
        }

        .preview-pane {
            grid-area: preview;
            padding: 10px;
            background-color: white;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

    </style>

</head>
<body>

<div class="outer-container">
    <div class="preview-pane">
        <iframe></iframe>
    </div>
</div>


<script type="module">
import build from '/build-html.js'


async function main() {

    const sourceUrl = '__SOURCE__'
    const response = await fetch(sourceUrl)
    const source = await response.text()

    const iframe = document.querySelector('iframe')
    const htmlOutput = build(source)

    let lastModified

    iframe.srcdoc = htmlOutput

    // poll the server for changes to current file and reload when it changes
    setInterval(async function () {
        const response = await fetch('/poll/status')
        const newList = await response.json()

        const entry = newList[sourceUrl.slice(1)]

        if (!lastModified) {
            lastModified = entry
        } else if (entry !== lastModified) {
            lastModified = entry

            const response = await fetch(sourceUrl)
            const source = await response.text()
            const htmlOutput = build(source)
            iframe.srcdoc = htmlOutput
        }
    }, 2000)
}


main()

</script>

</body>
</html>
